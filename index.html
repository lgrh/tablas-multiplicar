<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Práctica de Tablas de Multiplicar</title>
    <style>
        /* Regla global para asegurar que el padding no aumente el ancho de los elementos */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            justify-content: flex-start; /* Alinea el contenido arriba */
            align-items: center;
            flex-direction: column;
            margin: 0;
            padding: 20px;
            min-height: 100vh; /* Asegura que el body ocupe al menos toda la pantalla */
        }

        .container {
            background-color: #fff;
            padding: 20px 40px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 1400px;
        }

        h1, h2 {
            text-align: center;
            color: #264653;
            margin-top: 0;
            margin-bottom: 10px;
        }

        #tablas-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .tabla-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background-color: #fafafa;
        }

        .tabla-card h3 {
            margin-top: 0;
            text-align: center;
            color: #333;
            border-bottom: 2px solid #2a9d8f;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }

        .mensaje-intentos {
            font-size: 0.85em;
            color: #666;
            text-align: center;
            margin-bottom: 10px;
            font-style: italic;
        }

        .fila-multiplicacion {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .fila-multiplicacion label {
            flex-basis: auto;
        }

        .fila-multiplicacion input {
            width: 50px;
            padding: 5px;
            border: 2px solid #ccc;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
            font-size: 16px; /* Tamaño mínimo para evitar zoom en iPhone */
        }

        /* Clases para validación */
        .input-correcto {
            border-color: #28a745;
            background-color: #e9f7ec;
        }

        .input-incorrecto {
            border-color: #dc3545;
            background-color: #f8d7da;
        }

        .respuesta-correcta {
            color: #28a745;
            font-size: 0.9em;
            margin-left: 5px;
        }

        .botones-container {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }

        .btn-validar {
            flex: 1;
            padding: 10px 20px;
            font-size: 1em;
            font-weight: bold;
            color: #fff;
            background-color: #2a9d8f;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .btn-validar:hover {
            background-color: #218278;
        }

        .btn-exportar {
            flex: 1;
            padding: 10px 20px;
            font-size: 1em;
            font-weight: bold;
            color: #fff;
            background-color: #f4a261;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .btn-exportar:hover {
            background-color: #e49251;
        }

        .btn-individual {
            background-color: #2a9d8f;
            color: white;
            border: none;
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            margin-top: 10px;
            width: 100%;
            transition: background-color 0.3s;
        }
        .btn-individual:hover { background-color: #218278; }

        #resultado {
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            margin-top: 20px;
        }

        /* Nuevo contenedor de menú adaptable */
        .menu-navegacion {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
            width: 180px;
        }

        .btn-examen {
            flex: 1;
            padding: 10px 20px;
            background-color: #e9c46a;
            color: #212529;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.3s;
        }
        .btn-examen:hover {
            background-color: #d9b45a;
        }

        .btn-inicio {
            flex: 1;
            padding: 10px 20px;
            background-color: #264653;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.3s;
        }
        .btn-inicio:hover {
            background-color: #1d3540;
        }

        /* Media Queries para móviles: Transforma los botones en una barra superior */
        @media (max-width: 768px) {
            html {
                scroll-padding-top: 75px; /* Espacio para el menú pegajoso al hacer scroll */
            }
            body {
                /* Revertir a layout de bloque normal para evitar problemas de flexbox en móviles */
                display: block;
                padding-top: 0;
            }
            .menu-navegacion {
                position: sticky;
                top: 0;
                right: 0;
                left: 0;
                width: 100%;
                flex-direction: row;
                background-color: #fff;
                padding: 10px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                justify-content: center;
                box-sizing: border-box;
                margin-bottom: 20px;
            }

            .menu-navegacion button {
                font-size: 0.9em;
                padding: 10px;
            }

            .container {
                width: 95%;
                padding: 15px;
                margin: 0 auto 20px auto; /* Centrar el contenedor y añadir margen inferior */
            }
        }

        /* Barra de navegación de scroll para tablas en móvil */
        .scroll-nav-container {
            display: none; /* Oculto por defecto, se activa con media query */
            position: fixed;
            top: 100px;
            left: 5px;
            width: auto;
            background-color: transparent;
            z-index: 999;
        }

        @media (max-width: 768px) {
            .scroll-nav-container {
                display: block;
                top: 80px;
            }
        }

        .scroll-nav-btn {
            display: block;
            width: 40px;
            height: 40px;
            line-height: 40px;
            margin-bottom: 5px;            background-color: #2a9d8f;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            line-height: 1;
        }
        .close-modal:hover {
            color: #000;
        }

        .modal-content h2 {
            margin-top: 0;
        }

        .modal-content .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .modal-content label {
            display: block;
            margin-bottom: 5px;
        }

        .modal-content input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            font-size: 16px; /* Evitar zoom en móviles */
        }

        /* Estilos para la tabla de errores del examen */
        .tabla-errores {
            width: 100%;
            max-width: 600px;
            margin: 10px auto;
            border-collapse: collapse;
            text-align: left;
        }
        .tabla-errores th, .tabla-errores td {
            padding: 8px 12px;
            border-bottom: 1px solid #ddd;
        }
        .tabla-errores th { background-color: #f8f9fa; }

        /* Estilos específicos para el diseño del examen */
        .examen-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .examen-columna {
            display: flex;
            flex-direction: column;
            gap: 10px;
            background-color: #fafafa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .examen-item {
            display: flex;
            align-items: center;
            gap: 10px; /* Mantiene pregunta y respuesta juntas */
        }

        .examen-item label {
            font-size: 1.1em;
            font-weight: bold;
            min-width: 80px;
            text-align: right;
            margin: 0;
        }

        .examen-item input {
            width: 60px;
            text-align: center;
            font-weight: bold;
            padding: 5px;
            border: 2px solid #ccc;
            font-size: 16px; /* Tamaño mínimo para evitar zoom en iPhone */
        }

        .hidden {
            display: none !important;
        }

        #examen-container {
            width: 100%;
        }
    </style>
</head>
<body>

    <div class="menu-navegacion" id="menu-navegacion">
        <button class="btn-inicio hidden" id="btn-practica" onclick="volverAlInicio()">Práctica</button>
        <button class="btn-examen" onclick="mostrarModalExamen()">Examen</button>
        <button class="btn-validar" id="btn-validar-menu" onclick="validarRespuestas()">Validar</button>
        <button class="btn-exportar" onclick="exportarLog()">Exportar</button>
        <!--<button class="btn-exportar" onclick="mostrarModalCelebracion()" style="background-color: #e83e8c;">Test Anim</button>-->
    </div>

    <div class="container" id="main-container">
        <h1>Práctica de Tablas de Multiplicar</h1>
        <p style="text-align: center; margin-top: 0; margin-bottom: 15px;">Completa las tablas de multiplicar del 1 al 10 y luego presiona el botón para validar tus respuestas.</p>

        <div id="tablas-container"></div>

        <div id="resultado"></div>
    </div>

    <div class="container hidden" id="examen-container">
        <!-- El contenido del examen se generará aquí -->
    </div>

    <div class="scroll-nav-container" id="scroll-nav">
        <button class="scroll-nav-btn" onclick="scrollToTabla(1)">1</button>
        <button class="scroll-nav-btn" onclick="scrollToTabla(2)">2</button>
        <button class="scroll-nav-btn" onclick="scrollToTabla(3)">3</button>
        <button class="scroll-nav-btn" onclick="scrollToTabla(4)">4</button>
        <button class="scroll-nav-btn" onclick="scrollToTabla(5)">5</button>
        <button class="scroll-nav-btn" onclick="scrollToTabla(6)">6</button>
        <button class="scroll-nav-btn" onclick="scrollToTabla(7)">7</button>
        <button class="scroll-nav-btn" onclick="scrollToTabla(8)">8</button>
        <button class="scroll-nav-btn" onclick="scrollToTabla(9)">9</button>
        <button class="scroll-nav-btn" onclick="scrollToTabla(10)">10</button>
    </div>

    <div class="modal-overlay hidden" id="modal-celebracion">
        <div class="modal-content" style="text-align: center;">
            <h2>¡Felicidades!</h2>
            <p id="celebracion-mensaje">¡Has completado toda la práctica a la perfección!</p>
            <img src="peach.gif" alt="Personaje animado bailando" style="max-width: 80%; border-radius: 10px; margin-top: 10px;">
            <button class="btn-validar" style="margin-top: 20px;" onclick="cerrarModalCelebracion()">¡Genial!</button>
        </div>
    </div>

    <div class="modal-overlay hidden" id="modal-examen">
        <div class="modal-content">
            <span class="close-modal" onclick="cerrarModalExamen()">&times;</span>
            <h2>Configuración del Examen</h2>
            <div class="form-group">
                <label for="num-reactivos">Número de preguntas:</label>
                <input type="number" inputmode="numeric" id="num-reactivos" value="20" min="1" onkeydown="return event.key !== '-' && event.key !== 'e'">
            </div>
            <div class="form-group">
                <label for="tabla-inicio">De la tabla del:</label>
                <input type="number" inputmode="numeric" id="tabla-inicio" value="1" min="1" onkeydown="return event.key !== '-' && event.key !== 'e'">
            </div>
            <div class="form-group">
                <label for="tabla-fin">Hasta la tabla del:</label>
                <input type="number" inputmode="numeric" id="tabla-fin" value="10" min="1" placeholder="Opcional" onkeydown="return event.key !== '-' && event.key !== 'e'">
            </div>
            <button class="btn-validar" onclick="iniciarExamen()">Iniciar Examen</button>
        </div>
    </div>

    <script>
        // Se ejecuta cuando la página ha cargado completamente
        document.addEventListener('DOMContentLoaded', function() {
            generarTablas();
        });

        // Variables de estado
        let mostrarRespuestas = false;
        let intentoGlobal = 1;
        let intentosPorTabla = new Array(11).fill(0); // Índices 1-10
        let tablasCompletadas = new Array(11).fill(false);
        let preguntasExamen = [];
        let historialLog = "REGISTRO DE ACTIVIDAD\n=====================\n"; // Variable para acumular el log
        let examenTablaInicio, examenTablaFin;

        // Escuchar combinación de teclas Alt + r para alternar (toggle) respuestas
        document.addEventListener('keydown', function(event) {
            if (event.altKey && event.key.toLowerCase() === 'r') {
                mostrarRespuestas = !mostrarRespuestas; // Alternar estado

                for (let i = 1; i <= 10; i++) {
                    for (let j = 1; j <= 10; j++) {
                        const span = document.getElementById(`res-${i}-${j}`);
                        if (mostrarRespuestas) {
                            span.textContent = `(${i * j})`;
                        } else {
                            span.textContent = '';
                        }
                    }
                }
            }
        });

        // Función para generar dinámicamente las tablas de multiplicar
        function generarTablas() {
            const container = document.getElementById('tablas-container');
            let html = '';

            for (let i = 1; i <= 10; i++) {
                html += `<div class="tabla-card" id="tabla-card-${i}">`;
                html += `<h3>Tabla del ${i}</h3>`;
                html += `<div id="intentos-tabla-${i}" class="mensaje-intentos">Pendiente de completar</div>`;
                for (let j = 1; j <= 10; j++) {
                    html += `
                        <div class="fila-multiplicacion">
                            <label for="input-${i}-${j}">${i} x ${j} =</label>
                            <input type="number" inputmode="numeric" id="input-${i}-${j}" data-factor1="${i}" data-factor2="${j}" min="0" onkeydown="handlePracticaInputKeydown(event, ${i}, ${j})">
                            <span id="res-${i}-${j}" class="respuesta-correcta"></span>
                        </div>
                    `;
                }
                html += `<button class="btn-individual" onclick="validarTabla(${i})">Validar Tabla ${i}</button>`;
                html += `</div>`;
            }
            container.innerHTML = html;
        }

        function handlePracticaInputKeydown(event, table, multiplier) {
            if (event.key === '-' || event.key === 'e') {
                event.preventDefault();
                return;
            }

            if (event.key === 'Enter') {
                event.preventDefault();
                
                // Intentar ir al siguiente multiplicador de la misma tabla
                let nextInput = document.getElementById(`input-${table}-${multiplier + 1}`);
                
                if (!nextInput) {
                    // Si no hay, intentar ir al primero de la siguiente tabla
                    nextInput = document.getElementById(`input-${table + 1}-1`);
                }

                if (nextInput) {
                    nextInput.focus();
                } else {
                    // Si es el último (10x10), enfocar el botón de validar del menú
                    const btnValidar = document.getElementById('btn-validar-menu');
                    if (btnValidar) btnValidar.focus();
                }
            }
        }

        function scrollToTabla(numeroTabla) {
            const tabla = document.getElementById(`tabla-card-${numeroTabla}`);
            if (tabla) {
                tabla.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Función para validar las respuestas del usuario
        function validarRespuestas() {
            let totalCorrectas = 0;
            
            // Validamos todas las tablas una por una sin descargar el archivo todavía
            for (let i = 1; i <= 10; i++) {
                totalCorrectas += validarTabla(i, false); 
            }

            // Mostrar el resultado final global
            const divResultado = document.getElementById('resultado');
            divResultado.innerHTML = `Tu puntuación global es: <span style="color: #2a9d8f;">${totalCorrectas}</span> de 100 correctas.`;

            // Si se completan las 100, mostrar la animación
            if (totalCorrectas === 100) {
                document.getElementById('celebracion-mensaje').textContent = '¡Has completado toda la práctica a la perfección!';
                mostrarModalCelebracion();
            }

            // Guardar en log global
            historialLog += `\n[${new Date().toLocaleTimeString()}] VALIDACIÓN GLOBAL: ${totalCorrectas}/100 aciertos.\n`;
            historialLog += `--------------------------------------------------\n`;
        }

        // Función para validar una tabla individual
        // El parámetro 'autoGuardar' define si descargamos el archivo inmediatamente
        function validarTabla(numeroTabla, autoGuardar = true) {
            let aciertosEnEstaTabla = 0;
            
            // Limpiar respuestas mostradas si no está activo el modo trampa
            if (!mostrarRespuestas) {
                for(let j=1; j<=10; j++) {
                    document.getElementById(`res-${numeroTabla}-${j}`).textContent = '';
                }
            }

            for (let j = 1; j <= 10; j++) {
                const input = document.getElementById(`input-${numeroTabla}-${j}`);
                const valorUsuario = parseInt(input.value, 10);
                const respuestaCorrecta = numeroTabla * j;

                // Remover clases de validación previas
                input.classList.remove('input-correcto', 'input-incorrecto');

                if (!isNaN(valorUsuario) && valorUsuario === respuestaCorrecta) {
                    input.classList.add('input-correcto');
                    aciertosEnEstaTabla++;
                } else {
                    input.classList.add('input-incorrecto');
                }
            }

            // Lógica de intentos por tabla
            if (!tablasCompletadas[numeroTabla]) {
                intentosPorTabla[numeroTabla]++;
                const divIntentos = document.getElementById(`intentos-tabla-${numeroTabla}`);
                
                if (aciertosEnEstaTabla === 10) {
                    tablasCompletadas[numeroTabla] = true;
                    divIntentos.textContent = `¡Completada correctamente en ${intentosPorTabla[numeroTabla]} intentos!`;
                    divIntentos.style.color = '#28a745';
                    divIntentos.style.fontWeight = 'bold';
                } else {
                    divIntentos.textContent = `Intento actual: ${intentosPorTabla[numeroTabla]} (Errores detectados)`;
                }
            }

            // Si es validación individual, guardamos el log
            if (autoGuardar) {
                historialLog += `[${new Date().toLocaleTimeString()}] Tabla ${numeroTabla}: ${aciertosEnEstaTabla}/10 aciertos. (Intento #${intentosPorTabla[numeroTabla]})\n`;

                // Después de validar, revisar si TODAS las tablas están completas
                let todasCompletas = true;
                for (let i = 1; i <= 10; i++) {
                    if (!tablasCompletadas[i]) {
                        todasCompletas = false;
                        break;
                    }
                }
                if (todasCompletas) {
                    document.getElementById('celebracion-mensaje').textContent = '¡Has completado toda la práctica a la perfección!';
                    mostrarModalCelebracion();
                }
            }
            
            return aciertosEnEstaTabla;
        }

        // --- LÓGICA DEL EXAMEN ---

        function mostrarModalCelebracion() {
            document.getElementById('modal-celebracion').classList.remove('hidden');
        }

        function cerrarModalCelebracion() {
            document.getElementById('modal-celebracion').classList.add('hidden');
        }

        function mostrarModalExamen() {
            document.getElementById('modal-examen').classList.remove('hidden');
        }

        function cerrarModalExamen() {
            document.getElementById('modal-examen').classList.add('hidden');
        }

        function iniciarExamen() {
            const numPreguntas = parseInt(document.getElementById('num-reactivos').value);
            const tablaInicio = parseInt(document.getElementById('tabla-inicio').value);
            let tablaFinInput = document.getElementById('tabla-fin').value;
            let tablaFin;

            if (tablaFinInput.trim() === '') {
                tablaFin = tablaInicio;
            } else {
                tablaFin = parseInt(tablaFinInput);
            }

            if (isNaN(numPreguntas) || isNaN(tablaInicio) || isNaN(tablaFin) || numPreguntas <= 0 || tablaInicio <= 0 || tablaFin < tablaInicio) {
                alert("Por favor, introduce valores válidos. El número de preguntas debe ser mayor a 0 y la tabla de fin debe ser mayor o igual a la de inicio.");
                return;
            }

            examenTablaInicio = tablaInicio;
            examenTablaFin = tablaFin;

            // Prevenir bucle infinito si se piden más preguntas de las posibles
            const maxPreguntasPosibles = (tablaFin - tablaInicio + 1) * 10;
            if (numPreguntas > maxPreguntasPosibles) {
                alert(`No se pueden generar ${numPreguntas} preguntas únicas. El máximo para el rango seleccionado es ${maxPreguntasPosibles}. Por favor, ajusta el número de preguntas.`);
                return;
            }

            document.getElementById('main-container').classList.add('hidden');
            document.getElementById('examen-container').classList.remove('hidden');
            document.getElementById('btn-validar-menu').classList.add('hidden');
            document.getElementById('btn-practica').classList.remove('hidden');
            document.getElementById('scroll-nav').classList.add('hidden');
            cerrarModalExamen();
            generarExamen(numPreguntas, tablaInicio, tablaFin);
        }

        function generarExamen(numPreguntas, tablaInicio, tablaFin) {
            preguntasExamen = [];
            const preguntasUnicas = new Set();
            const examenContainer = document.getElementById('examen-container');
            let html = '<h1>Examen</h1>';

            let descripcionExamen = `<p style="text-align: center; margin-bottom: 20px;">Resuelve las multiplicaciones de las tablas del ${tablaInicio}`;
            if (tablaInicio !== tablaFin) {
                descripcionExamen += ` al ${tablaFin}`;
            }
            descripcionExamen += `.</p>`;
            html += descripcionExamen;

            let intentos = 0;
            const maxIntentos = 2000; // Límite de seguridad para evitar bucles infinitos

            while (preguntasExamen.length < numPreguntas) {
                intentos++;
                if (intentos > maxIntentos) {
                    break;
                }

                let factor1 = Math.floor(Math.random() * (tablaFin - tablaInicio + 1)) + tablaInicio;
                let factor2 = Math.floor(Math.random() * 10) + 1;

                // Clave única para evitar repetidos (2x9 es lo mismo que 9x2)
                const clave = [factor1, factor2].sort().join('x');
                if (preguntasUnicas.has(clave)) {
                    continue; // Pregunta ya generada, intentar de nuevo
                }
                preguntasUnicas.add(clave);

                // Aleatorizar el orden de los factores (capcioso)
                if (Math.random() > 0.5) {
                    [factor1, factor2] = [factor2, factor1];
                }

                preguntasExamen.push({
                    pregunta: `${factor1} x ${factor2}`,
                    respuesta: factor1 * factor2
                });
            }

            // Si faltan preguntas para completar el número solicitado, rellenar aleatoriamente
            while (preguntasExamen.length < numPreguntas) {
                let factor1 = Math.floor(Math.random() * (tablaFin - tablaInicio + 1)) + tablaInicio;
                let factor2 = Math.floor(Math.random() * 10) + 1;

                if (Math.random() > 0.5) {
                    [factor1, factor2] = [factor2, factor1];
                }

                preguntasExamen.push({
                    pregunta: `${factor1} x ${factor2}`,
                    respuesta: factor1 * factor2
                });
            }

            // Generar HTML para las preguntas
            html += '<div class="examen-grid">';
            // Crear columnas de 10 en 10
            for (let i = 0; i < preguntasExamen.length; i += 10) {
                html += '<div class="examen-columna">';
                for (let j = i; j < Math.min(i + 10, preguntasExamen.length); j++) {
                    const p = preguntasExamen[j];
                    html += `
                        <div class="examen-item">
                            <label for="examen-input-${j}">${p.pregunta} =</label>
                            <input type="number" inputmode="numeric" id="examen-input-${j}" min="0" onkeydown="handleExamenInputKeydown(event, ${j})">
                            <span id="examen-res-${j}" class="respuesta-correcta"></span>
                        </div>
                    `;
                }
                html += '</div>';
            }
            html += '</div>';

            html += `<div id="examen-botones-container" class="botones-container"><button class="btn-validar" onclick="validarExamen()">Calificar Examen</button></div>`;
            html += `<div id="examen-resultado"></div>`;
            examenContainer.innerHTML = html;
        }

        function handleExamenInputKeydown(event, currentIndex) {
            // Prevent entering '-' or 'e' in number inputs
            if (event.key === '-' || event.key === 'e') {
                event.preventDefault();
                return;
            }

            // On 'Enter', move to the next input
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent default form submission

                const nextIndex = currentIndex + 1;
                const nextInput = document.getElementById(`examen-input-${nextIndex}`);

                if (nextInput) {
                    nextInput.focus();
                } else {
                    // If it's the last input, focus the "Calificar Examen" button
                    document.querySelector('#examen-botones-container .btn-validar').focus();
                }
            }
        }

        function validarExamen() {
            let correctas = 0;
            let erroresHtml = '<h4>Repaso de errores:</h4><table class="tabla-errores"><thead><tr><th>Pregunta</th><th>Propiedad Conmutativa</th></tr></thead><tbody>';
            let hayErrores = false;

            preguntasExamen.forEach((p, index) => {
                const input = document.getElementById(`examen-input-${index}`);
                const valorUsuario = parseInt(input.value, 10);
                const spanRespuesta = document.getElementById(`examen-res-${index}`);

                input.classList.remove('input-correcto', 'input-incorrecto');
                spanRespuesta.textContent = '';

                if (!isNaN(valorUsuario) && valorUsuario === p.respuesta) {
                    input.classList.add('input-correcto');
                    correctas++;
                } else {
                    input.classList.add('input-incorrecto');
                    spanRespuesta.textContent = `(${p.respuesta})`; // Muestra la respuesta correcta
                    
                    // Obtener factores para mostrar la propiedad conmutativa
                    const partes = p.pregunta.split(' x ');
                    const f1 = partes[0];
                    const f2 = partes[1];
                    
                    erroresHtml += `<tr>
                        <td>${p.pregunta} = <strong>${p.respuesta}</strong><br><span style="font-size: 0.9em; color: #dc3545;">(Tu respuesta: ${input.value || '"ninguna"'})</span></td>
                        <td style="white-space: nowrap;">Es lo mismo: <strong>${f2} x ${f1} = ${p.respuesta}</strong></td>
                    </tr>`;
                    hayErrores = true;
                }
            });

            const resultadoDiv = document.getElementById('examen-resultado');
            let resultadoFinalHtml = `<h3>Resultado: ${correctas} de ${preguntasExamen.length} correctas.</h3>`;

            if (hayErrores) {
                resultadoFinalHtml += erroresHtml + '</tbody></table>';
            }

            resultadoDiv.innerHTML = resultadoFinalHtml;

            // Si el examen es perfecto y tiene 20 o más preguntas, mostrar celebración
            if (correctas === preguntasExamen.length && preguntasExamen.length >= 20) {
                document.getElementById('celebracion-mensaje').textContent = '¡Has conseguido una calificación perfecta en el examen!';
                mostrarModalCelebracion();
            }

            // Actualizar log
            let descripcionExamenLog = `Tablas del ${examenTablaInicio}`;
            if (examenTablaInicio !== examenTablaFin) {
                descripcionExamenLog += ` al ${examenTablaFin}`;
            }
            historialLog += `\n[${new Date().toLocaleTimeString()}] EXAMEN: ${correctas}/${preguntasExamen.length} aciertos. (${descripcionExamenLog})\n`;
            historialLog += `--------------------------------------------------\n`;

            // Cambiar botón
            const botonesContainer = document.getElementById('examen-botones-container');
            botonesContainer.innerHTML = `
                <button class="btn-inicio" onclick="retomarExamen()" style="margin-right: 10px; background-color: #17a2b8;">Repetir el Examen</button>
                <button class="btn-inicio" onclick="volverAlInicio(false)">Volver a la Práctica</button>
            `;
        }

        function retomarExamen() {
            // Limpiar inputs y estilos
            preguntasExamen.forEach((_, index) => {
                const input = document.getElementById(`examen-input-${index}`);
                const spanRespuesta = document.getElementById(`examen-res-${index}`);
                
                input.value = '';
                input.classList.remove('input-correcto', 'input-incorrecto');
                spanRespuesta.textContent = '';
            });

            // Limpiar resultados
            document.getElementById('examen-resultado').innerHTML = '';
            
            // Restaurar botón de calificar
            const botonesContainer = document.getElementById('examen-botones-container');
            botonesContainer.innerHTML = `<button class="btn-validar" onclick="validarExamen()">Calificar Examen</button>`;
        }

        function volverAlInicio(pedirConfirmacion = true) {
            const examenContainer = document.getElementById('examen-container');
            // Solo pedir confirmación si estamos en la vista de examen y hay preguntas cargadas
            if (pedirConfirmacion && !examenContainer.classList.contains('hidden') && preguntasExamen.length > 0) {
                let algunaRespuesta = false;
                // Revisar si el usuario ha escrito algo en algún campo
                for (let i = 0; i < preguntasExamen.length; i++) {
                    const input = document.getElementById(`examen-input-${i}`);
                    if (input && input.value.trim() !== '') {
                        algunaRespuesta = true;
                        break;
                    }
                }

                if (algunaRespuesta && !confirm("¿Estás seguro de que quieres salir? Perderás el progreso del examen actual.")) {
                    return; // Si el usuario cancela, no hacer nada
                }
            }

            document.getElementById('main-container').classList.remove('hidden');
            document.getElementById('btn-validar-menu').classList.remove('hidden');
            document.getElementById('btn-practica').classList.add('hidden');
            document.getElementById('scroll-nav').classList.remove('hidden');
            examenContainer.classList.add('hidden');
            examenContainer.innerHTML = ''; // Limpiar contenido
            preguntasExamen = []; // Reiniciar el array de preguntas del examen
        }

        function exportarLog() {
            descargarArchivo('Registro de actividad_tablas de multiplicar.txt', historialLog);
        }

        function descargarArchivo(nombre, contenido) {
            const elemento = document.createElement('a');
            elemento.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(contenido));
            elemento.setAttribute('download', nombre);
            elemento.style.display = 'none';
            document.body.appendChild(elemento);
            elemento.click();
            document.body.removeChild(elemento);
        }
    </script>

</body>
</html>
